{% extends 'base.html' %}
{% load report_filters %}

{% block title %}ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ{% endblock %}

{% block content %}

<h2 style="margin-bottom: 15px;">ğŸ¢ ØªÙ‚Ø±ÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</h2>

<style>
    .filter-box {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .filter-box label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
    }

    .filter-box select {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 12px;
        font-size: 15px;
    }

    .btn-filter {
        width: 100%;
        padding: 10px;
        background: #0d6efd;
        border: none;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        font-size: 16px;
    }

    .btn-filter:hover {
        background: #0a58ca;
    }

    .report-table {
        width: 100%;
        background: #fff;
        border-radius: 12px;
        padding: 0;
        margin-top: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border-collapse: collapse;
    }

    .report-table th {
        background: #0d6efd;
        color: white;
        padding: 12px;
        text-align: center;
        font-size: 15px;
    }

    .report-table td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #eee;
        font-size: 14px;
    }

    .percent {
        font-weight: bold;
        color: #0d6efd;
    }

    .no-data {
        text-align: center;
        padding: 20px;
        font-size: 16px;
        background: #fff;
        border-radius: 12px;
        margin-top: 20px;
    }
</style>

<!-- ============ ÙÙ„Ø§ØªØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ============ -->
<div class="filter-box">
    <form method="GET">
        <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
        <select name="region" id="regionSelect" onchange="loadCities(this.value)">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</option>
            {% for r in regions %}
                <option value="{{ r.id }}"
                    {% if r.id|stringformat:'s' == selected_region %}selected{% endif %}>
                    {{ r.name }}
                </option>
            {% endfor %}
        </select>

        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
        <select name="city" id="citySelect" onchange="loadBuildings(this.value)">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
            {% for c in cities %}
                <option value="{{ c.id }}"
                    {% if c.id|stringformat:'s' == selected_city %}selected{% endif %}>
                    {{ c.name }}
                </option>
            {% endfor %}
        </select>

        <label>Ø§Ù„Ù…Ø¨Ù†Ù‰:</label>
        <select name="building" id="buildingSelect">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰</option>
            {% for b in buildings %}
                <option value="{{ b.id }}"
                    {% if b.id|stringformat:'s' == selected_building %}selected{% endif %}>
                    {{ b.name }}
                </option>
            {% endfor %}
        </select>

        <button class="btn-filter">ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </form>
</div>

<a href="?export=1" class="btn-filter" style="background:green;margin-bottom:10px;">
    ğŸ“¥ ØªØµØ¯ÙŠØ± Excel
    </a>

<!-- ============ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ============ -->
{% if data %}
<table class="report-table">
    <tr>
        <th>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
        <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
        <th>Ø§Ù„Ù…Ø¨Ù†Ù‰</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„</th>
        <th>Ù…Ø¬Ø±ÙˆØ¯</th>
        <th>ØºÙŠØ± Ù…Ø¬Ø±ÙˆØ¯</th>
        <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</th>
    </tr>

    {% for row in data %}
    {% with percent=row.scanned|percentage:row.total %}
    <tr>
        <td>{{ row.region }}</td>
        <td>{{ row.city }}</td>
        <td>{{ row.building }}</td>
        <td>{{ row.total }}</td>
        <td>{{ row.scanned }}</td>
        <td>{{ row.not_scanned }}</td>
        <td class="percent">{{ percent }}%</td>
    </tr>
    {% endwith %}
    {% endfor %}
</table>
{% else %}
<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø«</div>
{% endif %}

<!-- ============ Ø³ÙƒØ±Ø¨Øª AJAX ============ -->
<script>
function loadCities(regionId) {
    fetch(`/reports/ajax/get-cities/${regionId}/`)
        .then(res => res.json())
        .then(data => {
            let citySelect = document.getElementById("citySelect");
            citySelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>`;

            data.forEach(c => {
                citySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            document.getElementById("buildingSelect").innerHTML =
                `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰</option>`;
        });
}

function loadBuildings(cityId) {
    fetch(`/reports/ajax/get-buildings/${cityId}/`)
        .then(res => res.json())
        .then(data => {
            let buildingSelect = document.getElementById("buildingSelect");
            buildingSelect.innerHTML = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰</option>`;

            data.forEach(b => {
                buildingSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
            });
        });
}
</script>

{% endblock %}
